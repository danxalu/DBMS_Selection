# Кейс 2. Банк «Прогресс»
---

## Какие ключевые требования к СУБД в этом кейсе?

- **OLAP-производительность:** колонночное хранение, векторные вычисления, MPP, распределённость.  
- **История в 10 лет:** секционирование по дате/региону; компрессия; TTL.  
- **Разделение контуров:** загрузка через ETL/ELT/CDC без влияния на OLTP.  
- **Агрегации и витрины:** материализованные представления, инкрементальные рефреши.  
- **Конкурентный доступ:** десятки/сотни одновременных аналитических запросов, изоляция ресурсов.  
- **Надёжность:** репликация, отказоустойчивость, резервные копии.  
- **Безопасность:** шифрование "в покое/в транзите", RLS/CLS, аудит, маскирование PII. 
- **Экономичность:** компрессия, разделение storage/compute, авто-scale, «холодные» партиции.

src: https://studfile.net/preview/5589329/page:6/

---

## Какие сложности или ограничения могут возникнуть при выборе СУБД?

- **CDC и задержки:** сложность стриминга изменений (Debezium/Kafka/WAL-шиппинг), договорённый SLA свежести.  
- **Качество данных:** дедупликация, SCD, согласование справочников/регионов.  
- **Эволюция схемы:** schema drift, миграции, договоры данных.  
- **Стоимость:** облака — плата за скан/хранение/конкурентность.
- **Оптимизация:** неверное партиционирование/распределение ломает производительность.  
- **Комплаенс:** ПДн, геофенсинг, аудит доступа.

---

## Какие классы СУБД подходят для решения задачи?

- **Колонночные MPP OLAP:** ClickHouse, Greenplum, Apache Doris, Apache Druid/Pinot (real-time OLAP).  
- **Облачные DW/Lakehouse:** Snowflake, Google BigQuery, Amazon Redshift, Databricks SQL.  
- **HTAP-платформы** (реже для банков): SingleStore, TiDB, YugabyteDB + внешний OLAP.
- **Классические реляционные СУБД (OLTP/аналитика лёгкого уровня):** PostgreSQL.

---

## Приведите примеры конкретных СУБД, которые вы бы выбрали.

| Сценарий | Рекомендуемая СУБД | Почему |
|-----------|--------------------|---------|
| Облако, строгий контроль, высокий трафик | **ClickHouse** | Очень быстрые агрегации, отличная компрессия, секционирование/матвью/мердж-деревья, горизонтальное масштабирование, зрелые коннекторы. |
| Локализованность в РФ | **PostgreSQL** | Реляционная СУБД, поддерживающая принципы ACID, важные для правильной обработки денежных транзакций: атомарность, eventual consistency, изолированность с блокировками. |
| Enterprise с SQL-совместимостью | **Greenplum** | PostgreSQL-совместимость, зрелый MPP, внешние таблицы, сильные джойны по звезде. |

---

## Обоснуйте ваш выбор: почему именно эта СУБД?

### **ClickHouse**

**Почему:**  
Топ-производительность для агрегирующей аналитики, дешёвая длительная история за счёт компрессии, гибкие партиции (`toYYYYMM(date)` × регион), материализованные витрины, нативный стрим-ингест (Kafka/Redpanda).  

**Как внедрять:**  
1. CDC из OLTP (Oracle/PostgreSQL) -> Kafka -> ClickHouse (`Kafka Engine` + `Materialized View`).  
2. Модель «звезда»: факты продаж + измерения (клиент*, продукт, филиал, регион, календарь).  
3. Витрина `sales_m_y_region` с инкрементальным апдейтом по закрытию месяца.  
4. BI: Power BI/Tableau/Superset -> только чтение.  
5. Ротация: горячие 24 месяца на быстрых дисках, остальное — холодное хранилище/реплики.

src: https://clickhouse.com/docs/ru

---

### **PostgreSQL**

Подходит при объёмах **до нескольких сотен ГБ**, менее десяти тысяч пользователей.

**Когда стоит:**
- Отдельный кластер под аналитику + логическая репликация/CDC.  
- Модель «звезда», партиционирование по месяцу/году, кластеризация по региону/продукту.  
- Индексы: **BRIN** по дате, **B-tree** по join-ключам.  
- Материализованные представления (MV) для месячных/квартальных агрегатов; по возможности — инкрементальные.  
- Включить **parallel query** и аккуратно **JIT**; тюнинг `work_mem`, `effective_cache_size`.  
- Для масштаба — **Citus** (шардинг, MPP).  

**Когда не стоит:**
- Объёмы в терабайтах, тяжёлые full-scan агрегации, сотни аналитиков — OLAP-движки (тот же ClickHouse) предсказуемее и дешевле.

src: https://postgrespro.ru/docs/postgresql/current

---

## Какие риски или проблемы могут возникнуть при эксплуатации выбранной СУБД?

### Риски при использовании **ClickHouse**

- **Задержка данных при CDC:**  
  Инкрементальная загрузка через Kafka или лог-шиппинг может давать лаг; важно мониторить отставание топиков и ставить алерты.

- **Всплески BI-нагрузки:**  
  При одновременных аналитических запросах возможна конкуренция за CPU/память. Решение — настройка `max_concurrent_queries`, изоляция пулов, подготовленные витрины.  

- **Стоимость хранения и бэкапов:**  
  Хотя ClickHouse дешёв по хранению, бэкапы и репликация при 10-летней истории занимают значительные объёмы. Рекомендуется ротация старых партиций и использование `TTL`.  

- **Удаления и апдейты:**  
  ClickHouse не оптимизирован под частые UPDATE/DELETE. Следует применять append-only подход или «замещающие» таблицы (`ReplacingMergeTree`).  

- **Сложность администрирования MPP-кластера:**  
  Репликации, шардинг, балансировка данных требуют DevOps-компетенций; полезно автоматизировать через Ansible/Kubernetes/ClickHouse Keeper.  

- **Комплаенс и безопасность:**  
  Нет встроенного RLS — реализуется логикой приложения или представлениями. Важно настроить аудит запросов и шифрование в движении (`TLS`).  

- **Согласованность данных:**  
  Eventual consistency между репликами; важно проектировать пайплайн CDC с идемпотентностью и версионированием записей.

src: https://clickhouse.com/docs/ru/tips-and-tricks/community-wisdom

---

### Риски при использовании **PostgreSQL (в роли аналитического DWH)**

- **MVCC-разбухание и VACUUM-нагрузка:**  
  Из-за механизма многоверсионности (`MVCC`) большие факт-таблицы быстро накапливают «мусор». Требуется регулярный `VACUUM` и `ANALYZE`, иначе деградация производительности.  

- **Отсутствие изоляции ресурсов:**  
  PostgreSQL не умеет ограничивать CPU/память по пользователям. BI-запросы могут мешать ETL-процессам → рекомендуется выделять отдельный сервер или кластер.  

- **Партиционирование и планировщик:**  
  При большом количестве партиций (100+) оптимизатор иногда сканирует лишние. Следует тщательно настраивать `constraint_exclusion` и проверять планы (`EXPLAIN ANALYZE`).  

- **Ограниченная масштабируемость:**  
  Без расширений (например, **Citus**) PostgreSQL не тянет MPP-нагрузки и full-scan агрегаты на терабайтных объёмах.  

- **Отсутствие колоннарности:**  
  PostgreSQL хранит данные строками (row-store), что замедляет агрегации по длинным временным диапазонам. Частично решается `cstore_fdw` или Citus Columnar, но не на уровне OLAP.  

- **Сложность инкрементальных материализованных представлений:**  
  Стандартный `REFRESH MATERIALIZED VIEW` пересоздаёт витрину целиком. Для инкрементов требуется `pg_ivm` или ручная логика.  

- **Качество данных и CDC:**  
  Логическая репликация через WAL может отставать или терять транзакции при сбое; важно использовать проверенные коннекторы (Debezium/wal2json) и мониторинг позиций репликации.  

- **Безопасность и комплаенс:**  
  PostgreSQL поддерживает RLS, но требует ручной настройки политик. Шифрование данных «на диске» нужно реализовывать средствами ОС или внешними расширениями (например, `pgcrypto`).  

---

### Общие риски для обеих систем

- **Ошибки в дизайне схемы:** неверный выбор партиционирования и ключей сортировки ухудшает производительность.  
- **Качество данных:** дубликаты, пропуски и рассинхронизация при CDC. Рекомендуется автоматическое тестирование (Great Expectations, dbt tests).   
- **Архивирование:** хранение 10-летней истории требует ротации, компрессии и политики TTL.

---

## Справочник

| Аббревиатура | Расшифровка | Назначение | Особенность / отличие |
|---------------|--------------|-------------|------------------------|
| **OLTP** | Online Transaction Processing | Операционные транзакционные системы | Оптимизированы для большого числа коротких транзакций (INSERT/UPDATE/SELECT по ключу), обеспечивают целостность и ACID. Не подходят для агрегаций по миллионам строк. |
| **OLAP** | Online Analytical Processing | Аналитические запросы и агрегации | Работает с большими объёмами данных, выполняет сложные агрегаты и группировки. Использует колонночное хранение и векторные вычисления. |
| **DW/DWH** | Data Warehouse | Хранилище данных для аналитики | Централизованное хранилище очищенных данных из разных систем. Отличается структурированной схемой («звезда», «снежинка») и предобработкой под отчёты. |
| **Lakehouse** | Data Lake + Warehouse | Гибрид озера и хранилища данных | Объединяет гибкость Data Lake и управляемость DWH. Поддерживает SQL, ACID и формат таблиц (Parquet/Iceberg/Delta). |
| **MPP** | Massively Parallel Processing | Параллельные вычисления на кластере | Разбивает запрос на подзадачи между узлами кластера, что позволяет линейно масштабировать аналитику. В отличие от SMP — масштабируется горизонтально. |
| **CDC** | Change Data Capture | Поток изменений из OLTP | Позволяет фиксировать изменения в источнике и передавать их в DWH. Главное отличие — работает в реальном времени (стриминг), а не по расписанию, как ETL. |
| **ETL/ELT** | Extract-Transform-Load / Extract-Load-Transform | Загрузка и трансформация данных | В ETL данные преобразуются до загрузки, в ELT — уже внутри DWH (например, с помощью SQL/dbt). ELT эффективнее при мощном аналитическом движке. |
| **SCD** | Slowly Changing Dimensions | История изменений атрибутов | Позволяет хранить историю измерений (например, изменение региона клиента). Отличается типами (Type 1/2/3) — разная логика версионирования. |
| **RLS/CLS** | Row/Column-Level Security | Ограничение доступа по строкам/столбцам | Гранулярная безопасность: позволяет ограничить видимость данных на уровне строк или колонок. В ClickHouse требует обходных решений. |
| **PII** | Personally Identifiable Information | Персональные данные | Любая информация, по которой можно идентифицировать человека. Требует маскирования и шифрования по закону (GDPR, 152-ФЗ). |
| **BI** | Business Intelligence | Аналитика и отчётность | Слой визуализации данных (Power BI, Tableau). Отличается тем, что работает поверх DWH и не хранит «сырые» данные. |
| **SLA** | Service Level Agreement | Гарантированные показатели обслуживания | Документ или метрика, определяющая допустимую задержку обновления данных, доступность системы и т.п. Отличается от SLO тем, что юридически фиксируется. |
| **TTL** | Time To Live | Автоматическое удаление/архивирование | Механизм автоматического удаления старых данных. В ClickHouse реализуется на уровне таблицы, без триггеров или фоновых задач. |
| **WAL** | Write-Ahead Log | Журнал транзакций, источник CDC | Журнал предзаписи изменений в PostgreSQL и других СУБД. Основное отличие — гарантирует надёжность и используется для репликации. |
| **MV** | Materialized View | Материализованное представление (витрина) | Физически хранит результаты запроса. Быстрее обычных VIEW, но требует обновления (`REFRESH` или потокового обновления). |
| **MVCC** | Multi-Version Concurrency Control | Многоверсионность данных | Обеспечивает изоляцию транзакций без блокировок. Отличается тем, что сохраняет старые версии строк, что приводит к росту размера таблиц (VACUUM). |
| **BRIN** | Block Range Index | Компактный индекс по диапазонам (PostgreSQL) | Индексирует не каждую строку, а диапазон страниц. Очень лёгкий, подходит для больших таблиц с естественной сортировкой по дате. |
| **JIT** | Just-In-Time compilation | Ускорение выполнения запросов | Компиляция SQL-плана в машинный код. В PostgreSQL ускоряет тяжёлые агрегации, но неэффективен на коротких запросах. |
| **HTAP** | Hybrid Transactional/Analytical Processing | Совместная обработка OLTP и OLAP | Позволяет выполнять аналитику на тех же данных, где идут транзакции. Отличается низкой задержкой и сложностью реализации (пример — TiDB, SingleStore). |
| **ANSI SQL** | American National Standards Institute SQL | Стандарт SQL | Обеспечивает переносимость запросов между СУБД. Отличается от диалектов (например, T-SQL, PL/pgSQL) своей независимостью от вендора. |
| **dbt** | data build tool | Инструмент для трансформации данных в DWH | Применяет SQL как код (Data as Code), управляет зависимостями и тестами. Отличается декларативностью и прозрачностью пайплайнов. |
| **Apache Iceberg** | — | Формат таблиц для озёр данных с time-travel | Поддерживает ACID и эволюцию схемы поверх файловых систем (S3, HDFS). Отличается стабильностью версий и метаданными на уровне каталога. |
| **Citus** | — | Расширение PostgreSQL для MPP и шардинга | Делает PostgreSQL распределённым. Отличается от стандартного Postgres тем, что умеет горизонтально масштабироваться по узлам. |

---

Для ответов на вопросы использовались LLM ChatGPT-5 и DeepSeek-V3.2 и источники (src). С LLM были проведены споры и рассуждения. Добавлена информация, основанная на личном профессиональном опыте: например, о PostgreSQL, особенностях реляционных баз данных и необходимости локализации в РФ.

---
